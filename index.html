<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://www.gstatic.com https://firebase.google.com 'unsafe-inline'; object-src 'none';">
  <title>Pride Welfare Society</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1, h2, h3 {
      color: #333;
    }
    input, button, select {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .edit-button {
      background-color: #28a745;
      margin: 5px;
    }
    .edit-button:hover {
      background-color: #218838;
    }
    .delete-button {
      background-color: #dc3545;
      margin: 5px;
    }
    .delete-button:hover {
      background-color: #c82333;
    }
    #userInfo, #receiptSection, #memberReceipts, #oldBalanceSection, #bankSection, #expensesSection, #editReceiptSection, #createdReceipts, #editBalanceSection, #editBankSection, #editExpenseSection, #memberDashboard, #dueDetails, #expenseDetails {
      margin-top: 20px;
      display: none;
    }
    .receipt, .bank-entry, .expense, .member {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .clickable {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
    }
    .clickable:hover {
      color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pride Welfare Society</h1>

    <!-- Login Section -->
    <div id="loginSection">
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button id="loginButton">Login</button>
    </div>

    <!-- User Info Section -->
    <div id="userInfo">
      <h2>Welcome, <span id="userName"></span>!</h2>
      <p>Role: <span id="userRole"></span></p>
      <button id="logoutButton">Logout</button>
    </div>

    <!-- Member Dashboard -->
    <div id="memberDashboard">
      <h3>Dashboard</h3>
      <p>Bank Balance: <span id="totalBankBalance">0</span></p>
      <p>Total Due Amount: <span id="totalDueAmount" class="clickable" onclick="toggleDueDetails()">0</span></p>
      <div id="dueDetails"></div>
      <p>Cash in Hand: <span id="cashInHand">0</span></p>
      <p>Total Expenses: <span id="totalExpenses" class="clickable" onclick="toggleExpenseDetails()">0</span></p>
      <div id="expenseDetails"></div>
    </div>

    <!-- Old Balance Section for Treasurer -->
    <div id="oldBalanceSection">
      <h3>Manage Old Balance</h3>
      <select id="balanceMemberId">
        <option value="">Select Member</option>
      </select>
      <input type="number" id="oldBalanceAmount" placeholder="Old Balance Amount" />
      <button id="updateBalanceButton">Update Balance</button>
      <div id="memberList"></div>
    </div>

    <!-- Edit Balance Section -->
    <div id="editBalanceSection" style="display: none;">
      <h3>Edit Old Balance</h3>
      <input type="hidden" id="editBalanceMemberId" />
      <input type="number" id="editBalanceAmount" placeholder="Old Balance Amount" />
      <button id="saveEditBalanceButton">Save Changes</button>
      <button id="cancelEditBalanceButton">Cancel</button>
    </div>

    <!-- Bank Section for Treasurer -->
    <div id="bankSection">
      <h3>Bank Details</h3>
      <input type="text" id="bankName" placeholder="Bank Name" />
      <input type="number" id="bankAmount" placeholder="Amount" />
      <button id="addBankButton">Add Bank Entry</button>
      <div id="bankList"></div>
    </div>

    <!-- Edit Bank Entry Section -->
    <div id="editBankSection" style="display: none;">
      <h3>Edit Bank Entry</h3>
      <input type="hidden" id="editBankId" />
      <input type="text" id="editBankName" placeholder="Bank Name" />
      <input type="number" id="editBankAmount" placeholder="Amount" />
      <button id="saveEditBankButton">Save Changes</button>
      <button id="cancelEditBankButton">Cancel</button>
    </div>

    <!-- Expenses Section for Treasurer -->
    <div id="expensesSection">
      <h3>Expenses</h3>
      <input type="text" id="expenseDescription" placeholder="Description" />
      <input type="number" id="expenseAmount" placeholder="Amount" />
      <select id="expensePaymentMode">
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
      </select>
      <button id="addExpenseButton">Add Expense</button>
      <div id="expenseList"></div>
    </div>

    <!-- Edit Expense Section -->
    <div id="editExpenseSection" style="display: none;">
      <h3>Edit Expense</h3>
      <input type="hidden" id="editExpenseId" />
      <input type="text" id="editExpenseDescription" placeholder="Description" />
      <input type="number" id="editExpenseAmount" placeholder="Amount" />
      <select id="editExpensePaymentMode">
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
      </select>
      <button id="saveEditExpenseButton">Save Changes</button>
      <button id="cancelEditExpenseButton">Cancel</button>
    </div>

    <!-- Receipt Section for Treasurer and Caretaker -->
    <div id="receiptSection">
      <h3>Create Receipt</h3>
      <select id="receiptMemberId">
        <option value="">Select Member</option>
      </select>
      <input type="number" id="receiptAmount" placeholder="Amount" />
      <select id="receiptStatus">
        <option value="temporary">Temporary</option>
        <option value="final" id="finalReceiptOption">Final</option>
      </select>
      <input type="text" id="receiptNumber" placeholder="Receipt Number (for Final)" style="display: none;" />
      <select id="paymentMode">
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
      </select>
      <button id="createReceiptButton">Create Receipt</button>
    </div>

    <!-- Created Receipts Section for Treasurer and Caretaker -->
    <div id="createdReceipts">
      <h3>Created Receipts</h3>
      <div id="createdReceiptList"></div>
    </div>

    <!-- Edit Receipt Section for Members -->
    <div id="editReceiptSection" style="display: none;">
      <h3>Edit Receipt</h3>
      <input type="hidden" id="editReceiptId" />
      <input type="number" id="editReceiptAmount" placeholder="Amount" />
      <select id="editPaymentMode">
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
      </select>
      <button id="saveEditReceiptButton">Save Changes</button>
      <button id="cancelEditReceiptButton">Cancel</button>
    </div>

    <!-- Receipts Section for Members -->
    <div id="memberReceipts">
      <h3>Your Receipts</h3>
      <div id="receiptList"></div>
    </div>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, where, query, serverTimestamp, increment, orderBy } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDMWuYa4plIxdgj48r4q_NmEENZgvBx7VY",
      authDomain: "pridewelfare-2b002.firebaseapp.com",
      projectId: "pridewelfare-2b002",
      storageBucket: "pridewelfare-2b002.firebasestorage.app",
      messagingSenderId: "1070532082236",
      appId: "1:1070532082236:web:26b3e2434b5a38102ba139",
      measurementId: "G-54HPPE7MM4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserRole = '';
    let currentUserName = '';

    // Check Auth State
    onAuthStateChanged(auth, (user) => {
      console.log("Auth state changed. User:", user ? user.uid : "Not logged in");
      if (user) {
        fetchUserData(user.uid);
      } else {
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("userInfo").style.display = "none";
        document.getElementById("oldBalanceSection").style.display = "none";
        document.getElementById("bankSection").style.display = "none";
        document.getElementById("expensesSection").style.display = "none";
        document.getElementById("receiptSection").style.display = "none";
        document.getElementById("createdReceipts").style.display = "none";
        document.getElementById("memberReceipts").style.display = "none";
        document.getElementById("editReceiptSection").style.display = "none";
        document.getElementById("editBalanceSection").style.display = "none";
        document.getElementById("editBankSection").style.display = "none";
        document.getElementById("editExpenseSection").style.display = "none";
        document.getElementById("memberDashboard").style.display = "none";
        document.getElementById("dueDetails").style.display = "none";
        document.getElementById("expenseDetails").style.display = "none";
      }
    });

    // Login Function
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      console.log("Attempting login with email:", email);

      if (!email || !password) {
        alert("Please enter both email and password!");
        return;
      }

      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          console.log("Login successful. User UID:", user.uid);
          fetchUserData(user.uid);
        })
        .catch((error) => {
          console.error("Login error:", error.code, error.message);
          alert("Login failed: " + error.message);
        });
    }

    // Fetch User Data
    function fetchUserData(uid) {
      console.log("Fetching user data for UID:", uid);
      getDoc(doc(db, "users", uid))
        .then((docSnap) => {
          if (docSnap.exists()) {
            const userData = docSnap.data();
            console.log("User data fetched:", userData);
            document.getElementById("userName").innerText = userData.name;
            document.getElementById("userRole").innerText = userData.role;
            currentUserRole = userData.role;
            currentUserName = userData.name;

            document.getElementById("loginSection").style.display = "none";
            document.getElementById("userInfo").style.display = "block";

            if (userData.role === "treasurer") {
              document.getElementById("oldBalanceSection").style.display = "block";
              document.getElementById("bankSection").style.display = "block";
              document.getElementById("expensesSection").style.display = "block";
              document.getElementById("receiptSection").style.display = "block";
              document.getElementById("createdReceipts").style.display = "block";
              document.getElementById("finalReceiptOption").style.display = "block";
              loadMembers();
              loadMemberBalances();
              loadBankDetails();
              loadExpenses();
              loadCreatedReceipts(uid);
            } else if (userData.role === "caretaker") {
              document.getElementById("receiptSection").style.display = "block";
              document.getElementById("createdReceipts").style.display = "block";
              document.getElementById("finalReceiptOption").style.display = "none";
              loadMembers();
              loadCreatedReceipts(uid);
            } else if (userData.role === "member") {
              document.getElementById("memberReceipts").style.display = "block";
              document.getElementById("memberDashboard").style.display = "block";
              loadMemberReceipts(uid);
              loadMemberDashboard();
            }
          } else {
            console.log("User data not found for UID:", uid);
            alert("User data not found!");
          }
        })
        .catch((error) => {
          console.error("Error fetching user data:", error.message);
          alert("Error fetching user data: " + error.message);
        });
    }

    // Load Members into Dropdowns (for Receipts and Old Balance)
    function loadMembers() {
      console.log("Loading members for dropdowns...");
      const memberSelect = document.getElementById("receiptMemberId");
      const balanceMemberSelect = document.getElementById("balanceMemberId");
      const q = query(collection(db, "users"), where("role", "==", "member"));
      getDocs(q)
        .then((querySnapshot) => {
          console.log("Members query result:", querySnapshot.docs.length, "members found");
          querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const option = document.createElement("option");
            option.value = doc.id;
            option.text = userData.name;
            option.dataset.phone = userData.phone || '';
            console.log("Member:", userData.name, "Phone:", userData.phone);
            memberSelect.appendChild(option);

            if (balanceMemberSelect) {
              const balanceOption = document.createElement("option");
              balanceOption.value = doc.id;
              balanceOption.text = userData.name + " (Balance: " + (userData.oldBalance || 0) + ")";
              balanceMemberSelect.appendChild(balanceOption);
            }
          });
        })
        .catch((error) => {
          console.error("Error loading members: ", error);
          alert("Error loading members: " + error.message);
        });
    }

    // Load Member Dashboard (for Members)
    async function loadMemberDashboard() {
      // Load Total Bank Balance
      let totalBankBalance = 0;
      const bankSnapshot = await getDocs(collection(db, "bank"));
      bankSnapshot.forEach((doc) => {
        const bankData = doc.data();
        totalBankBalance += bankData.amount || 0;
      });
      document.getElementById("totalBankBalance").innerText = totalBankBalance;

      // Load Total Due Amount and Member-wise Due
      let totalDue = 0;
      const dueDetails = document.getElementById("dueDetails");
      dueDetails.innerHTML = "";
      const membersSnapshot = await getDocs(query(collection(db, "users"), where("role", "==", "member")));
      for (const memberDoc of membersSnapshot.docs) {
        const memberData = memberDoc.data();
        let memberDue = memberData.oldBalance || 0;
        const receiptsSnapshot = await getDocs(query(collection(db, "receipts"), where("memberId", "==", memberDoc.id)));
        receiptsSnapshot.forEach((receiptDoc) => {
          const receiptData = receiptDoc.data();
          memberDue += receiptData.amount || 0;
        });
        totalDue += memberDue;

        const memberDiv = document.createElement("div");
        memberDiv.className = "member";
        memberDiv.innerHTML = `
          <p>Name: ${memberData.name}</p>
          <p>Due Amount: ${memberDue}</p>
        `;
        dueDetails.appendChild(memberDiv);
      }
      document.getElementById("totalDueAmount").innerText = totalDue;

      // Calculate Cash in Hand
      let cashInHand = 0;
      const receiptsSnapshot = await getDocs(collection(db, "receipts"));
      receiptsSnapshot.forEach((doc) => {
        const receiptData = doc.data();
        if (receiptData.paymentMode === "Cash") {
          cashInHand += receiptData.amount || 0;
        }
      });
      const cashExpensesSnapshot = await getDocs(collection(db, "expenses"));
      cashExpensesSnapshot.forEach((doc) => {
        const expenseData = doc.data();
        if (expenseData.paymentMode === "Cash") {
          cashInHand -= expenseData.amount || 0;
        }
      });
      document.getElementById("cashInHand").innerText = cashInHand;

      // Load Total Expenses and Details
      let totalExpenses = 0;
      const expenseDetails = document.getElementById("expenseDetails");
      expenseDetails.innerHTML = "";
      const expensesQuery = query(collection(db, "expenses"), orderBy("createdAt", "desc"));
      const expenseDetailsSnapshot = await getDocs(expensesQuery);
      expenseDetailsSnapshot.forEach((doc) => {
        const expenseData = doc.data();
        totalExpenses += expenseData.amount || 0;

        const expenseDiv = document.createElement("div");
        expenseDiv.className = "expense";
        expenseDiv.innerHTML = `
          <p>Description: ${expenseData.description}</p>
          <p>Amount: ${expenseData.amount}</p>
          <p>Payment Mode: ${expenseData.paymentMode || 'N/A'}</p>
          <p>Created At: ${expenseData.createdAt ? new Date(expenseData.createdAt.toMillis()).toLocaleString() : "N/A"}</p>
        `;
        expenseDetails.appendChild(expenseDiv);
      });
      document.getElementById("totalExpenses").innerText = totalExpenses;
    }

    // Toggle Due Details Visibility
    window.toggleDueDetails = function() {
      const dueDetails = document.getElementById("dueDetails");
      dueDetails.style.display = dueDetails.style.display === "block" ? "none" : "block";
    };

    // Toggle Expense Details Visibility
    window.toggleExpenseDetails = function() {
      const expenseDetails = document.getElementById("expenseDetails");
      expenseDetails.style.display = expenseDetails.style.display === "block" ? "none" : "block";
    };

    // Load Member Balances for Treasurer
    function loadMemberBalances() {
      console.log("Loading member balances...");
      const memberList = document.getElementById("memberList");
      memberList.innerHTML = "";
      const q = query(collection(db, "users"), where("role", "==", "member"));
      getDocs(q)
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            memberList.innerHTML = "<p>No members found.</p>";
            return;
          }
          querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const memberDiv = document.createElement("div");
            memberDiv.className = "member";
            memberDiv.innerHTML = `
              <p>Name: ${userData.name}</p>
              <p>Old Balance: ${userData.oldBalance || 0}</p>
              <button class="edit-button" onclick="editBalance('${doc.id}', ${userData.oldBalance || 0})">Edit</button>
              <button class="delete-button" onclick="deleteBalance('${doc.id}')">Delete</button>
            `;
            memberList.appendChild(memberDiv);
          });
        })
        .catch((error) => {
          alert("Error loading member balances: " + error.message);
        });
    }

    // Update Old Balance (Treasurer only)
    function updateOldBalance() {
      const memberId = document.getElementById("balanceMemberId").value;
      const oldBalance = document.getElementById("oldBalanceAmount").value;
      const user = auth.currentUser;

      console.log("Updating old balance. Member ID:", memberId, "Balance:", oldBalance);

      if (!user) {
        alert("You need to be logged in to update balance!");
        return;
      }
      if (!memberId || !oldBalance) {
        alert("Please select a member and enter an amount!");
        return;
      }

      setDoc(doc(db, "users", memberId), { oldBalance: parseFloat(oldBalance) }, { merge: true })
        .then(() => {
          alert("Old balance updated successfully!");
          document.getElementById("balanceMemberId").value = "";
          document.getElementById("oldBalanceAmount").value = "";
          const balanceMemberSelect = document.getElementById("balanceMemberId");
          balanceMemberSelect.innerHTML = '<option value="">Select Member</option>';
          loadMembers();
          loadMemberBalances();
        })
        .catch((error) => {
          alert("Error updating old balance: " + error.message);
        });
    }

    // Edit Old Balance
    window.editBalance = function(memberId, oldBalance) {
      document.getElementById("editBalanceMemberId").value = memberId;
      document.getElementById("editBalanceAmount").value = oldBalance;
      document.getElementById("editBalanceSection").style.display = "block";
      document.getElementById("oldBalanceSection").style.display = "none";
    };

    // Save Edited Balance
    function saveEditedBalance() {
      const memberId = document.getElementById("editBalanceMemberId").value;
      const oldBalance = document.getElementById("editBalanceAmount").value;

      if (!oldBalance) {
        alert("Please enter an amount!");
        return;
      }

      setDoc(doc(db, "users", memberId), { oldBalance: parseFloat(oldBalance) }, { merge: true })
        .then(() => {
          alert("Old balance updated successfully!");
          document.getElementById("editBalanceSection").style.display = "none";
          document.getElementById("oldBalanceSection").style.display = "block";
          loadMemberBalances();
          const balanceMemberSelect = document.getElementById("balanceMemberId");
          balanceMemberSelect.innerHTML = '<option value="">Select Member</option>';
          loadMembers();
        })
        .catch((error) => {
          alert("Error updating old balance: " + error.message);
        });
    }

    // Cancel Edit Balance
    function cancelEditBalance() {
      document.getElementById("editBalanceSection").style.display = "none";
      document.getElementById("oldBalanceSection").style.display = "block";
    }

    // Delete Old Balance (Set to 0)
    window.deleteBalance = function(memberId) {
      if (confirm("Are you sure you want to delete this balance? It will be set to 0.")) {
        setDoc(doc(db, "users", memberId), { oldBalance: 0 }, { merge: true })
          .then(() => {
            alert("Old balance deleted (set to 0) successfully!");
            loadMemberBalances();
            const balanceMemberSelect = document.getElementById("balanceMemberId");
            balanceMemberSelect.innerHTML = '<option value="">Select Member</option>';
            loadMembers();
          })
          .catch((error) => {
            alert("Error deleting old balance: " + error.message);
          });
      }
    };

    // Add Bank Entry (Treasurer only)
    function addBankEntry() {
      const bankName = document.getElementById("bankName").value;
      const amount = document.getElementById("bankAmount").value;
      const user = auth.currentUser;

      console.log("Adding bank entry. Bank Name:", bankName, "Amount:", amount);

      if (!user) {
        alert("You need to be logged in to add a bank entry!");
        return;
      }
      if (!bankName || !amount) {
        alert("Please fill in all fields!");
        return;
      }

      addDoc(collection(db, "bank"), {
        bankName: bankName,
        amount: parseFloat(amount),
        createdBy: user.uid,
        createdAt: serverTimestamp()
      })
      .then(() => {
        alert("Bank entry added successfully!");
        document.getElementById("bankName").value = "";
        document.getElementById("bankAmount").value = "";
        loadBankDetails();
      })
      .catch((error) => {
        alert("Error adding bank entry: " + error.message);
      });
    }

    // Load Bank Details (Treasurer only)
    function loadBankDetails() {
      console.log("Loading bank details...");
      const bankList = document.getElementById("bankList");
      bankList.innerHTML = "";
      getDocs(collection(db, "bank"))
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            bankList.innerHTML = "<p>No bank entries found.</p>";
            return;
          }
          querySnapshot.forEach((doc) => {
            const bankData = doc.data();
            const bankDiv = document.createElement("div");
            bankDiv.className = "bank-entry";
            bankDiv.innerHTML = `
              <p>Bank Name: ${bankData.bankName}</p>
              <p>Amount: ${bankData.amount}</p>
              <p>Created By: ${bankData.createdBy}</p>
              <p>Created At: ${bankData.createdAt ? new Date(bankData.createdAt.toMillis()).toLocaleString() : "N/A"}</p>
              <button class="edit-button" onclick="editBank('${doc.id}', '${bankData.bankName}', ${bankData.amount})">Edit</button>
              <button class="delete-button" onclick="deleteBank('${doc.id}')">Delete</button>
            `;
            bankList.appendChild(bankDiv);
          });
        })
        .catch((error) => {
          alert("Error loading bank details: " + error.message);
        });
    }

    // Edit Bank Entry
    window.editBank = function(bankId, bankName, amount) {
      document.getElementById("editBankId").value = bankId;
      document.getElementById("editBankName").value = bankName;
      document.getElementById("editBankAmount").value = amount;
      document.getElementById("editBankSection").style.display = "block";
      document.getElementById("bankSection").style.display = "none";
    };

    // Save Edited Bank Entry
    function saveEditedBank() {
      const bankId = document.getElementById("editBankId").value;
      const bankName = document.getElementById("editBankName").value;
      const amount = document.getElementById("editBankAmount").value;

      if (!bankName || !amount) {
        alert("Please fill in all fields!");
        return;
      }

      updateDoc(doc(db, "bank", bankId), {
        bankName: bankName,
        amount: parseFloat(amount)
      })
      .then(() => {
        alert("Bank entry updated successfully!");
        document.getElementById("editBankSection").style.display = "none";
        document.getElementById("bankSection").style.display = "block";
        loadBankDetails();
      })
      .catch((error) => {
        alert("Error updating bank entry: " + error.message);
      });
    }

    // Cancel Edit Bank Entry
    function cancelEditBank() {
      document.getElementById("editBankSection").style.display = "none";
      document.getElementById("bankSection").style.display = "block";
    }

    // Delete Bank Entry
    window.deleteBank = function(bankId) {
      if (confirm("Are you sure you want to delete this bank entry?")) {
        deleteDoc(doc(db, "bank", bankId))
          .then(() => {
            alert("Bank entry deleted successfully!");
            loadBankDetails();
          })
          .catch((error) => {
            alert("Error deleting bank entry: " + error.message);
          });
      }
    };

    // Add Expense (Treasurer only)
    function addExpense() {
      const description = document.getElementById("expenseDescription").value;
      const amount = document.getElementById("expenseAmount").value;
      const paymentMode = document.getElementById("expensePaymentMode").value;
      const user = auth.currentUser;

      console.log("Adding expense. Description:", description, "Amount:", amount, "Payment Mode:", paymentMode);

      if (!user) {
        alert("You need to be logged in to add an expense!");
        return;
      }
      if (!description || !amount) {
        alert("Please fill in all fields!");
        return;
      }

      addDoc(collection(db, "expenses"), {
        description: description,
        amount: parseFloat(amount),
        paymentMode: paymentMode,
        createdBy: user.uid,
        createdAt: serverTimestamp()
      })
      .then(() => {
        alert("Expense added successfully!");
        document.getElementById("expenseDescription").value = "";
        document.getElementById("expenseAmount").value = "";
        document.getElementById("expensePaymentMode").value = "Cash";
        loadExpenses();
        sendExpenseMessageToMembers(description, amount, paymentMode);
      })
      .catch((error) => {
        alert("Error adding expense: " + error.message);
      });
    }

    // Send Expense Message to All Members
    function sendExpenseMessageToMembers(description, amount, paymentMode) {
      const q = query(collection(db, "users"), where("role", "==", "member"));
      getDocs(q)
        .then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const phone = userData.phone;
            console.log("Sending expense message to member:", userData.name, "Phone:", phone);
            if (phone) {
              const message = `New expense added: ${description}, Amount: ${amount}, Payment Mode: ${paymentMode}.`;
              const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
              console.log("Expense WhatsApp URL:", whatsappUrl);
              window.open(whatsappUrl, '_blank');
            } else {
              console.log("No phone number found for member:", userData.name);
            }
          });
        })
        .catch((error) => {
          console.error("Error fetching members for expense message: ", error);
        });
    }

    // Load Expenses (Treasurer only)
    function loadExpenses() {
      console.log("Loading expenses...");
      const expenseList = document.getElementById("expenseList");
      expenseList.innerHTML = "";
      getDocs(collection(db, "expenses"))
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            expenseList.innerHTML = "<p>No expenses found.</p>";
            return;
          }
          querySnapshot.forEach((doc) => {
            const expenseData = doc.data();
            const expenseDiv = document.createElement("div");
            expenseDiv.className = "expense";
            expenseDiv.innerHTML = `
              <p>Description: ${expenseData.description}</p>
              <p>Amount: ${expenseData.amount}</p>
              <p>Payment Mode: ${expenseData.paymentMode || 'N/A'}</p>
              <p>Created By: ${expenseData.createdBy}</p>
              <p>Created At: ${expenseData.createdAt ? new Date(expenseData.createdAt.toMillis()).toLocaleString() : "N/A"}</p>
              <button class="edit-button" onclick="editExpense('${doc.id}', '${expenseData.description}', ${expenseData.amount}, '${expenseData.paymentMode || 'Cash'}')">Edit</button>
              <button class="delete-button" onclick="deleteExpense('${doc.id}')">Delete</button>
            `;
            expenseList.appendChild(expenseDiv);
          });
        })
        .catch((error) => {
          alert("Error loading expenses: " + error.message);
        });
    }

    // Edit Expense
    window.editExpense = function(expenseId, description, amount, paymentMode) {
      document.getElementById("editExpenseId").value = expenseId;
      document.getElementById("editExpenseDescription").value = description;
      document.getElementById("editExpenseAmount").value = amount;
      document.getElementById("editExpensePaymentMode").value = paymentMode;
      document.getElementById("editExpenseSection").style.display = "block";
      document.getElementById("expensesSection").style.display = "none";
    };

    // Save Edited Expense
    function saveEditedExpense() {
      const expenseId = document.getElementById("editExpenseId").value;
      const description = document.getElementById("editExpenseDescription").value;
      const amount = document.getElementById("editExpenseAmount").value;
      const paymentMode = document.getElementById("editExpensePaymentMode").value;

      if (!description || !amount) {
        alert("Please fill in all fields!");
        return;
      }

      updateDoc(doc(db, "expenses", expenseId), {
        description: description,
        amount: parseFloat(amount),
        paymentMode: paymentMode
      })
      .then(() => {
        alert("Expense updated successfully!");
        document.getElementById("editExpenseSection").style.display = "none";
        document.getElementById("expensesSection").style.display = "block";
        loadExpenses();
      })
      .catch((error) => {
        alert("Error updating expense: " + error.message);
      });
    }

    // Cancel Edit Expense
    function cancelEditExpense() {
      document.getElementById("editExpenseSection").style.display = "none";
      document.getElementById("expensesSection").style.display = "block";
    }

    // Delete Expense
    window.deleteExpense = function(expenseId) {
      if (confirm("Are you sure you want to delete this expense?")) {
        deleteDoc(doc(db, "expenses", expenseId))
          .then(() => {
            alert("Expense deleted successfully!");
            loadExpenses();
          })
          .catch((error) => {
            alert("Error deleting expense: " + error.message);
          });
      }
    };

    // Create Receipt (Treasurer and Caretaker)
    async function createReceipt() {
      const memberId = document.getElementById("receiptMemberId").value;
      const amount = document.getElementById("receiptAmount").value;
      const status = document.getElementById("receiptStatus").value;
      const paymentMode = document.getElementById("paymentMode").value;
      const receiptNumberInput = document.getElementById("receiptNumber").value;
      const user = auth.currentUser;

      console.log("Creating receipt. Member ID:", memberId, "Amount:", amount, "Status:", status);

      if (!user) {
        alert("You need to be logged in to create a receipt!");
        return;
      }
      if (!memberId || !amount) {
        alert("Please fill in all fields!");
        return;
      }
      if (status === "final" && !receiptNumberInput) {
        alert("Please enter a receipt number for Final receipt!");
        return;
      }

      let receiptNumber = receiptNumberInput;
      if (status === "temporary") {
        const counterRef = doc(db, "counters", "receiptCounter");
        const counterSnap = await getDoc(counterRef);
        let currentCount = 0;
        if (counterSnap.exists()) {
          currentCount = counterSnap.data().temporaryReceiptCount || 0;
        }
        currentCount++;
        receiptNumber = `TEMP-${currentCount}`;
        await setDoc(counterRef, { temporaryReceiptCount: currentCount }, { merge: true });
      }

      const memberSelect = document.getElementById("receiptMemberId");
      const selectedOption = memberSelect.options[memberSelect.selectedIndex];
      const memberName = selectedOption.text;
      const memberPhone = selectedOption.dataset.phone;

      addDoc(collection(db, "receipts"), {
        memberId: memberId,
        memberName: memberName,
        amount: parseFloat(amount),
        createdBy: user.uid,
        createdByName: currentUserName,
        createdAt: serverTimestamp(),
        status: status,
        receiptNumber: receiptNumber,
        paymentMode: paymentMode
      })
      .then(() => {
        alert("Receipt created successfully!");
        document.getElementById("receiptMemberId").value = "";
        document.getElementById("receiptAmount").value = "";
        document.getElementById("receiptStatus").value = "temporary";
        document.getElementById("receiptNumber").value = "";
        document.getElementById("paymentMode").value = "Cash";
        loadCreatedReceipts(user.uid);

        if (currentUserRole === "caretaker") {
          const treasurerQuery = query(collection(db, "users"), where("role", "==", "treasurer"));
          getDocs(treasurerQuery).then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              const treasurerData = doc.data();
              const treasurerPhone = treasurerData.phone;
              console.log("Treasurer phone:", treasurerPhone);
              if (treasurerPhone) {
                const message = `Caretaker ${currentUserName} has generated a temporary receipt for ${memberName}, Amount: ${amount}, Receipt No: ${receiptNumber}.`;
                const whatsappUrl = `https://wa.me/${treasurerPhone}?text=${encodeURIComponent(message)}`;
                console.log("Treasurer WhatsApp URL:", whatsappUrl);
                window.open(whatsappUrl, '_blank');
              } else {
                console.log("No phone number found for treasurer");
              }
            });
          });

          console.log("Member phone:", memberPhone);
          if (memberPhone) {
            const message = `You have a new temporary receipt from Caretaker ${currentUserName}. Amount: ${amount}, Receipt No: ${receiptNumber}.`;
            const whatsappUrl = `https://wa.me/${memberPhone}?text=${encodeURIComponent(message)}`;
            console.log("Member WhatsApp URL:", whatsappUrl);
            window.open(whatsappUrl, '_blank');
          } else {
            console.log("No phone number found for member:", memberName);
          }
        } else if (currentUserRole === "treasurer") {
          console.log("Member phone:", memberPhone);
          if (memberPhone) {
            const message = `You have a new ${status} receipt from Treasurer. Amount: ${amount}, Receipt No: ${receiptNumber}.`;
            const whatsappUrl = `https://wa.me/${memberPhone}?text=${encodeURIComponent(message)}`;
            console.log("Member WhatsApp URL:", whatsappUrl);
            window.open(whatsappUrl, '_blank');
          } else {
            console.log("No phone number found for member:", memberName);
          }
        }
      })
      .catch((error) => {
        alert("Error creating receipt: " + error.message);
      });
    }

    // Load Created Receipts for Treasurer and Caretaker
    function loadCreatedReceipts(uid) {
      console.log("Loading created receipts for UID:", uid);
      const createdReceiptList = document.getElementById("createdReceiptList");
      createdReceiptList.innerHTML = "";
      const q = query(collection(db, "receipts"), where("createdBy", "==", uid));
      getDocs(q)
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            createdReceiptList.innerHTML = "<p>No receipts created.</p>";
            return;
          }
          querySnapshot.forEach((doc) => {
            const receipt = doc.data();
            const receiptDiv = document.createElement("div");
            receiptDiv.className = "receipt";
            receiptDiv.innerHTML = `
              <p>Receipt No: ${receipt.receiptNumber}</p>
              <p>Member: ${receipt.memberName}</p>
              <p>Amount: ${receipt.amount}</p>
              <p>Payment Mode: ${receipt.paymentMode}</p>
              <p>Status: ${receipt.status}</p>
              <p>Created At: ${receipt.createdAt ? new Date(receipt.createdAt.toMillis()).toLocaleString() : "N/A"}</p>
            `;
            createdReceiptList.appendChild(receiptDiv);
          });
        })
        .catch((error) => {
          alert("Error loading created receipts: " + error.message);
        });
    }

    // Load Receipts for Members
    function loadMemberReceipts(uid) {
      console.log("Loading receipts for member UID:", uid);
      const receiptList = document.getElementById("receiptList");
      receiptList.innerHTML = "";
      const q = query(collection(db, "receipts"), where("memberId", "==", uid));
      getDocs(q)
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            receiptList.innerHTML = "<p>No receipts found.</p>";
            return;
          }
          querySnapshot.forEach((doc) => {
            const receipt = doc.data();
            const receiptDiv = document.createElement("div");
            receiptDiv.className = "receipt";
            receiptDiv.innerHTML = `
              <p>Receipt No: ${receipt.receiptNumber}</p>
              <p>Amount: ${receipt.amount}</p>
              <p>Payment Mode: ${receipt.paymentMode}</p>
              <p>Status: ${receipt.status}</p>
              <p>Created By: ${receipt.createdByName}</p>
              <p>Created At: ${receipt.createdAt ? new Date(receipt.createdAt.toMillis()).toLocaleString() : "N/A"}</p>
              <button onclick="editReceipt('${doc.id}', ${receipt.amount}, '${receipt.paymentMode}')">Edit</button>
            `;
            receiptList.appendChild(receiptDiv);
          });
        })
        .catch((error) => {
          alert("Error loading receipts: " + error.message);
        });
    }

    // Edit Receipt (for Members)
    window.editReceipt = function(receiptId, amount, paymentMode) {
      document.getElementById("editReceiptId").value = receiptId;
      document.getElementById("editReceiptAmount").value = amount;
      document.getElementById("editPaymentMode").value = paymentMode;
      document.getElementById("editReceiptSection").style.display = "block";
      document.getElementById("memberReceipts").style.display = "none";
    };

    // Save Edited Receipt
    function saveEditedReceipt() {
      const receiptId = document.getElementById("editReceiptId").value;
      const amount = document.getElementById("editReceiptAmount").value;
      const paymentMode = document.getElementById("editPaymentMode").value;

      if (!amount) {
        alert("Please enter an amount!");
        return;
      }

      updateDoc(doc(db, "receipts", receiptId), {
        amount: parseFloat(amount),
        paymentMode: paymentMode
      })
      .then(() => {
        alert("Receipt updated successfully!");
        document.getElementById("editReceiptSection").style.display = "none";
        document.getElementById("memberReceipts").style.display = "block";
        loadMemberReceipts(auth.currentUser.uid);
      })
      .catch((error) => {
        alert("Error updating receipt: " + error.message);
      });
    }

    // Cancel Edit Receipt
    function cancelEditReceipt() {
      document.getElementById("editReceiptSection").style.display = "none";
      document.getElementById("memberReceipts").style.display = "block";
    }

    // Logout Function
    function logout() {
      console.log("Logging out...");
      signOut(auth)
        .then(() => {
          document.getElementById("loginSection").style.display = "block";
          document.getElementById("userInfo").style.display = "none";
          document.getElementById("oldBalanceSection").style.display = "none";
          document.getElementById("bankSection").style.display = "none";
          document.getElementById("expensesSection").style.display = "none";
          document.getElementById("receiptSection").style.display = "none";
          document.getElementById("createdReceipts").style.display = "none";
          document.getElementById("memberReceipts").style.display = "none";
          document.getElementById("editReceiptSection").style.display = "none";
          document.getElementById("editBalanceSection").style.display = "none";
          document.getElementById("editBankSection").style.display = "none";
          document.getElementById("editExpenseSection").style.display = "none";
          document.getElementById("memberDashboard").style.display = "none";
          document.getElementById("dueDetails").style.display = "none";
          document.getElementById("expenseDetails").style.display = "none";
        })
        .catch((error) => {
          alert("Logout failed: " + error.message);
        });
    }

    // Show/Hide Receipt Number Input based on Status
    document.getElementById("receiptStatus").addEventListener("change", function() {
      const status = this.value;
      const receiptNumberInput = document.getElementById("receiptNumber");
      if (status === "final") {
        receiptNumberInput.style.display = "block";
      } else {
        receiptNumberInput.style.display = "none";
        receiptNumberInput.value = "";
      }
    });

    // Add event listeners to buttons
    document.getElementById("loginButton").addEventListener("click", login);
    document.getElementById("logoutButton").addEventListener("click", logout);
    document.getElementById("updateBalanceButton").addEventListener("click", updateOldBalance);
    document.getElementById("addBankButton").addEventListener("click", addBankEntry);
    document.getElementById("addExpenseButton").addEventListener("click", addExpense);
    document.getElementById("createReceiptButton").addEventListener("click", createReceipt);
    document.getElementById("saveEditReceiptButton").addEventListener("click", saveEditedReceipt);
    document.getElementById("cancelEditReceiptButton").addEventListener("click", cancelEditReceipt);
    document.getElementById("saveEditBalanceButton").addEventListener("click", saveEditedBalance);
    document.getElementById("cancelEditBalanceButton").addEventListener("click", cancelEditBalance);
    document.getElementById("saveEditBankButton").addEventListener("click", saveEditedBank);
    document.getElementById("cancelEditBankButton").addEventListener("click", cancelEditBank);
    document.getElementById("saveEditExpenseButton").addEventListener("click", saveEditedExpense);
    document.getElementById("cancelEditExpenseButton").addEventListener("click", cancelEditExpense);
  </script>
</body>
</html>