<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://www.gstatic.com https://firebase.google.com 'unsafe-inline'; object-src 'none';">
  <title>Pride Welfare Society</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1, h2, h3 {
      color: #333;
    }
    input, button, select {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .edit-button {
      background-color: #28a745;
      margin: 5px;
    }
    .edit-button:hover {
      background-color: #218838;
    }
    .delete-button {
      background-color: #dc3545;
      margin: 5px;
    }
    .delete-button:hover {
      background-color: #c82333;
    }
    #userInfo, #receiptSection, #memberReceipts, #oldBalanceSection, #bankSection, #expensesSection, #editReceiptSection, #createdReceipts, #editBalanceSection, #editBankSection, #editExpenseSection, #societyDashboard, #memberDashboard {
      margin-top: 20px;
      display: none;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .dashboard-box {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    .dashboard-box h4 {
      margin: 0 0 5px 0;
      font-size: 14px;
      color: #555;
    }
    .dashboard-box p {
      margin: 0;
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    .receipt-list, .member-list, .receipt-table-container, .bank-table-container, .expense-table-container {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
    }
    .expense-table, .receipt-table, .bank-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .expense-table th, .expense-table td, .receipt-table th, .receipt-table td, .bank-table th, .bank-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    .expense-table th, .receipt-table th, .bank-table th {
      background-color: #f2f2f2;
      cursor: pointer;
    }
    .expense-table th:hover, .receipt-table th:hover, .bank-table th:hover {
      background-color: #e0e0e0;
    }
    .receipt, .bank-entry, .expense, .member {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .error-message {
      color: red;
      margin-top: 10px;
    }
    #memberSearch {
      margin-bottom: 10px;
    }
    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }
      input, button, select {
        padding: 8px;
        font-size: 14px;
      }
      h3 {
        font-size: 18px;
      }
      .dashboard-box h4 {
        font-size: 12px;
      }
      .dashboard-box p {
        font-size: 14px;
      }
      .receipt, .bank-entry, .expense, .member {
        font-size: 14px;
      }
      .expense-table th, .expense-table td, .receipt-table th, .receipt-table td, .bank-table th, .bank-table td {
        font-size: 12px;
        padding: 6px;
      }
      /* Receipt Table Columns */
      .receipt-table th:nth-child(1), .receipt-table td:nth-child(1) { /* Date or Receipt No. */
        width: 20%;
      }
      .receipt-table th:nth-child(2), .receipt-table td:nth-child(2) { /* Date or Receipt No. */
        width: 20%;
      }
      .receipt-table th:nth-child(3), .receipt-table td:nth-child(3) { /* Member Name */
        width: 30%;
      }
      .receipt-table th:nth-child(4), .receipt-table td:nth-child(4) { /* Mode of Payment */
        width: 15%;
      }
      .receipt-table th:nth-child(5), .receipt-table td:nth-child(5) { /* Amount */
        width: 15%;
      }
      /* Bank Table Columns */
      .bank-table th:nth-child(1), .bank-table td:nth-child(1) { /* Date */
        width: 30%;
      }
      .bank-table th:nth-child(2), .bank-table td:nth-child(2) { /* Bank Name */
        width: 40%;
      }
      .bank-table th:nth-child(3), .bank-table td:nth-child(3) { /* Amount */
        width: 30%;
      }
      /* Expense Table Columns */
      .expense-table th:nth-child(1), .expense-table td:nth-child(1) { /* Date */
        width: 20%;
      }
      .expense-table th:nth-child(2), .expense-table td:nth-child(2) { /* Particular */
        width: 40%;
      }
      .expense-table th:nth-child(3), .expense-table td:nth-child(3) { /* Amount */
        width: 20%;
      }
      .expense-table th:nth-child(4), .expense-table td:nth-child(4) { /* Mode of Payment */
        width: 20%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pride Welfare Society</h1>

    <!-- Login Section -->
    <div id="loginSection">
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button id="loginButton">Login</button>
    </div>

    <!-- User Info Section -->
    <div id="userInfo">
      <h2>Welcome, <span id="userName"></span>!</h2>
      <p>Role: <span id="userRole"></span></p>
      <button id="logoutButton">Logout</button>
    </div>

    <!-- Society Dashboard -->
    <div id="societyDashboard">
      <h3>Society Dashboard</h3>
      <div class="dashboard-grid">
        <div class="dashboard-box">
          <h4>Bank Balance</h4>
          <p id="totalBankBalance">0</p>
        </div>
        <div class="dashboard-box">
          <h4>Cash in Hand</h4>
          <p id="cashInHand">0</p>
        </div>
        <div class="dashboard-box">
          <h4>Total Expenses</h4>
          <p id="totalExpenses">0</p>
          <button onclick="toggleExpenseTable()" style="margin-top: 5px; padding: 5px;">View Expenses</button>
        </div>
      </div>
      <table id="expenseTable" class="expense-table">
        <thead>
          <tr>
            <th onclick="sortExpenseTable(0)">Date</th>
            <th>Particular</th>
            <th>Amount</th>
            <th>Mode of Payment</th>
          </tr>
        </thead>
        <tbody id="expenseTableBody"></tbody>
      </table>
    </div>

    <!-- Member Dashboard -->
    <div id="memberDashboard">
      <h3>Member Dashboard</h3>
      <div class="dashboard-grid">
        <div class="dashboard-box">
          <h4>Your Balance</h4>
          <p id="memberBalance">0</p>
        </div>
        <div class="dashboard-box">
          <h4>Your Total Receipts</h4>
          <p id="totalMemberReceipts">0</p>
        </div>
      </div>
    </div>

    <!-- Receipt Section for Treasurer and Caretaker -->
    <div id="receiptSection">
      <h3>Generate Receipt</h3>
      <select id="receiptMemberId">
        <option value="">Select Member</option>
      </select>
      <div id="receiptMemberError" class="error-message"></div>
      <input type="number" id="receiptAmount" placeholder="Amount" />
      <select id="receiptStatus">
        <option value="temporary">Temporary</option>
        <option value="final" id="finalReceiptOption">Final</option>
      </select>
      <input type="text" id="receiptNumber" placeholder="Receipt Number (for Final)" style="display: none;" />
      <select id="paymentMode">
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
      </select>
      <select id="receiptBankId" style="display: none;">
        <option value="">Select Bank</option>
      </select>
      <button id="createReceiptButton">Create Receipt</button>
    </div>

    <!-- Created Receipts Section for Treasurer and Caretaker -->
    <div id="createdReceipts">
      <h3>Created Receipts</h3>
      <div id="createdReceiptList" class="receipt-table-container">
        <table class="receipt-table">
          <thead>
            <tr>
              <th onclick="sortReceiptTable(0)">Date</th>
              <th>Receipt No.</th>
              <th>Member Name</th>
              <th>Mode of Payment</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody id="createdReceiptTableBody"></tbody>
        </table>
      </div>
      <div id="createdReceiptListError" class="error-message"></div>
    </div>

    <!-- Old Balance Section for Treasurer -->
    <div id="oldBalanceSection">
      <h3>Manage Old Balance</h3>
      <button onclick="toggleMemberList()">Show Members</button>
      <div id="memberListContainer" style="display: none;">
        <input type="text" id="memberSearch" placeholder="Search Member by Name" />
        <select id="balanceMemberId">
          <option value="">Select Member</option>
        </select>
        <div id="balanceMemberError" class="error-message"></div>
        <input type="number" id="oldBalanceAmount" placeholder="Old Balance Amount" />
        <button id="updateBalanceButton">Update Balance</button>
        <div id="memberList" class="member-list"></div>
        <div id="memberListError" class="error-message"></div>
      </div>
    </div>

    <!-- Edit Balance Section -->
    <div id="editBalanceSection" style="display: none;">
      <h3>Edit Old Balance</h3>
      <input type="hidden" id="editBalanceMemberId" />
      <input type="number" id="editBalanceAmount" placeholder="Old Balance Amount" />
      <button id="saveEditBalanceButton">Save Changes</button>
      <button id="cancelEditBalanceButton">Cancel</button>
    </div>

    <!-- Bank Section for Treasurer -->
    <div id="bankSection">
      <h3>Bank Details</h3>
      <input type="text" id="bankName" placeholder="Bank Name" />
      <input type="number" id="bankAmount" placeholder="Amount" />
      <button id="addBankButton">Add Bank Entry</button>
      <div id="bankList" class="bank-table-container">
        <table class="bank-table">
          <thead>
            <tr>
              <th onclick="sortBankTable(0)">Date</th>
              <th>Bank Name</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody id="bankTableBody"></tbody>
        </table>
      </div>
      <div id="bankListError" class="error-message"></div>
    </div>

    <!-- Edit Bank Entry Section -->
    <div id="editBankSection" style="display: none;">
      <h3>Edit Bank Entry</h3>
      <input type="hidden" id="editBankId" />
      <input type="text" id="editBankName" placeholder="Bank Name" />
      <input type="number" id="editBankAmount" placeholder="Amount" />
      <button id="saveEditBankButton">Save Changes</button>
      <button id="cancelEditBankButton">Cancel</button>
    </div>

    <!-- Expenses Section for Treasurer -->
    <div id="expensesSection">
      <h3>Expenses</h3>
      <input type="text" id="expenseDescription" placeholder="Description" />
      <input type="number" id="expenseAmount" placeholder="Amount" />
      <select id="expensePaymentMode">
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
      </select>
      <select id="expenseBankId" style="display: none;">
        <option value="">Select Bank</option>
      </select>
      <button id="addExpenseButton">Add Expense</button>
      <div id="expenseList" class="expense-table-container">
        <table class="expense-table">
          <thead>
            <tr>
              <th onclick="sortExpenseTable(0)">Date</th>
              <th>Particular</th>
              <th>Amount</th>
              <th>Mode of Payment</th>
            </tr>
          </thead>
          <tbody id="expenseTableBodyFull"></tbody>
        </table>
      </div>
      <div id="expenseListError" class="error-message"></div>
    </div>

    <!-- Edit Expense Section -->
    <div id="editExpenseSection" style="display: none;">
      <h3>Edit Expense</h3>
      <input type="hidden" id="editExpenseId" />
      <input type="text" id="editExpenseDescription" placeholder="Description" />
      <input type="number" id="editExpenseAmount" placeholder="Amount" />
      <select id="editExpensePaymentMode">
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
      </select>
      <select id="editExpenseBankId" style="display: none;">
        <option value="">Select Bank</option>
      </select>
      <button id="saveEditExpenseButton">Save Changes</button>
      <button id="cancelEditExpenseButton">Cancel</button>
    </div>

    <!-- Edit Receipt Section for Members -->
    <div id="editReceiptSection" style="display: none;">
      <h3>Edit Receipt</h3>
      <input type="hidden" id="editReceiptId" />
      <input type="number" id="editReceiptAmount" placeholder="Amount" />
      <select id="editPaymentMode">
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
      </select>
      <select id="editReceiptBankId" style="display: none;">
        <option value="">Select Bank</option>
      </select>
      <button id="saveEditReceiptButton">Save Changes</button>
      <button id="cancelEditReceiptButton">Cancel</button>
    </div>

    <!-- Receipts Section for Members -->
    <div id="memberReceipts">
      <h3>Your Receipts</h3>
      <div id="receiptList" class="receipt-table-container">
        <table class="receipt-table">
          <thead>
            <tr>
              <th>Receipt No.</th>
              <th>Date</th>
              <th>Member Name</th>
              <th>Mode of Payment</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody id="memberReceiptTableBody"></tbody>
        </table>
      </div>
      <div id="receiptListError" class="error-message"></div>
    </div>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, where, query, serverTimestamp, increment, orderBy } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDMWuYa4plIxdgj48r4q_NmEENZgvBx7VY",
      authDomain: "pridewelfare-2b002.firebaseapp.com",
      projectId: "pridewelfare-2b002",
      storageBucket: "pridewelfare-2b002.firebasestorage.app",
      messagingSenderId: "1070532082236",
      appId: "1:1070532082236:web:26b3e2434b5a38102ba139",
      measurementId: "G-54HPPE7MM4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserRole = '';
    let currentUserName = '';
    let allMembers = [];
    let receiptSortDirection = -1; // -1 for descending (newest first), 1 for ascending (oldest first)
    let bankSortDirection = -1;
    let expenseSortDirection = -1;

    // Helper function to format date to DD/MM/YYYY
    function formatDateToDDMMYYYY(timestamp) {
      if (!timestamp) return "N/A";
      const date = new Date(timestamp.toMillis());
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // Check Auth State
    onAuthStateChanged(auth, (user) => {
      console.log("Auth state changed. User:", user ? user.uid : "Not logged in");
      if (user) {
        fetchUserData(user.uid);
      } else {
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("userInfo").style.display = "none";
        document.getElementById("oldBalanceSection").style.display = "none";
        document.getElementById("bankSection").style.display = "none";
        document.getElementById("expensesSection").style.display = "none";
        document.getElementById("receiptSection").style.display = "none";
        document.getElementById("createdReceipts").style.display = "none";
        document.getElementById("memberReceipts").style.display = "none";
        document.getElementById("editReceiptSection").style.display = "none";
        document.getElementById("editBalanceSection").style.display = "none";
        document.getElementById("editBankSection").style.display = "none";
        document.getElementById("editExpenseSection").style.display = "none";
        document.getElementById("societyDashboard").style.display = "none";
        document.getElementById("memberDashboard").style.display = "none";
      }
    });

    // Login Function
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      console.log("Attempting login with email:", email);

      if (!email || !password) {
        alert("Please enter both email and password!");
        return;
      }

      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          console.log("Login successful. User UID:", user.uid);
          fetchUserData(user.uid);
        })
        .catch((error) => {
          console.error("Login error:", error.code, error.message);
          alert("Login failed: " + error.message);
        });
    }

    // Fetch User Data
    async function fetchUserData(uid) {
      console.log("Fetching user data for UID:", uid);
      try {
        const docSnap = await getDoc(doc(db, "users", uid));
        if (docSnap.exists()) {
          const userData = docSnap.data();
          console.log("User data fetched:", userData);
          document.getElementById("userName").innerText = userData.name;
          document.getElementById("userRole").innerText = userData.role;
          currentUserRole = userData.role;
          currentUserName = userData.name;

          document.getElementById("loginSection").style.display = "none";
          document.getElementById("userInfo").style.display = "block";

          // Show Society Dashboard for all roles
          document.getElementById("societyDashboard").style.display = "block";
          loadSocietyDashboard();

          if (userData.role === "treasurer") {
            document.getElementById("oldBalanceSection").style.display = "block";
            document.getElementById("bankSection").style.display = "block";
            document.getElementById("expensesSection").style.display = "block";
            document.getElementById("receiptSection").style.display = "block";
            document.getElementById("createdReceipts").style.display = "block";
            document.getElementById("finalReceiptOption").style.display = "block";
            loadMembers();
            loadMemberBalances();
            loadBankDetails();
            loadExpenses();
            loadCreatedReceipts(uid);
          } else if (userData.role === "caretaker") {
            document.getElementById("receiptSection").style.display = "block";
            document.getElementById("createdReceipts").style.display = "block";
            document.getElementById("finalReceiptOption").style.display = "none";
            loadMembers();
            loadCreatedReceipts(uid);
          } else if (userData.role === "member") {
            document.getElementById("memberReceipts").style.display = "block";
            document.getElementById("memberDashboard").style.display = "block";
            loadMemberReceipts(uid);
            await loadMemberDashboard(uid);
          }
        } else {
          console.log("User data not found for UID:", uid);
          alert("User data not found!");
        }
      } catch (error) {
        console.error("Error fetching user data:", error.message);
        alert("Error fetching user data: " + error.message);
      }
    }

    // Load Member Dashboard (for logged-in member)
    async function loadMemberDashboard(uid) {
      try {
        const memberDoc = await getDoc(doc(db, "users", uid));
        if (!memberDoc.exists()) {
          console.log("Member data not found for UID:", uid);
          return;
        }
        const memberData = memberDoc.data();
        let memberBalance = memberData.oldBalance || 0;

        const receiptsSnapshot = await getDocs(query(collection(db, "receipts"), where("memberId", "==", uid)));
        let totalReceiptsAmount = 0;
        receiptsSnapshot.forEach((receiptDoc) => {
          const receiptData = receiptDoc.data();
          if (receiptData.status === "final") {
            memberBalance -= receiptData.amount || 0;
          }
          totalReceiptsAmount += receiptData.amount || 0;
        });

        document.getElementById("memberBalance").innerText = memberBalance;
        document.getElementById("totalMemberReceipts").innerText = totalReceiptsAmount;
      } catch (error) {
        console.error("Error loading member dashboard:", error);
        document.getElementById("memberBalance").innerText = "Error";
        document.getElementById("totalMemberReceipts").innerText = "Error";
      }
    }

    // Load Society Dashboard (for all users)
    async function loadSocietyDashboard() {
      try {
        // Load Total Bank Balance
        let totalBankBalance = 0;
        const bankSnapshot = await getDocs(collection(db, "bank"));
        console.log("Bank snapshot:", bankSnapshot.docs.length, "entries found");
        bankSnapshot.forEach((doc) => {
          const bankData = doc.data();
          totalBankBalance += bankData.amount || 0;
        });
        document.getElementById("totalBankBalance").innerText = totalBankBalance;

        // Calculate Cash in Hand
        let cashInHand = 0;
        const receiptsSnapshot = await getDocs(collection(db, "receipts"));
        receiptsSnapshot.forEach((doc) => {
          const receiptData = doc.data();
          if (receiptData.paymentMode === "Cash" && receiptData.status === "final") {
            cashInHand += receiptData.amount || 0;
          }
        });
        const cashExpensesSnapshot = await getDocs(collection(db, "expenses"));
        cashExpensesSnapshot.forEach((doc) => {
          const expenseData = doc.data();
          if (expenseData.paymentMode === "Cash") {
            cashInHand -= expenseData.amount || 0;
          }
        });
        document.getElementById("cashInHand").innerText = cashInHand;

        // Load Total Expenses and Populate Expense Table
        let totalExpenses = 0;
        const expenseTableBody = document.getElementById("expenseTableBody");
        expenseTableBody.innerHTML = "";
        const expensesQuery = query(collection(db, "expenses"), orderBy("createdAt", "desc"));
        const expenseDetailsSnapshot = await getDocs(expensesQuery);
        console.log("Expenses snapshot for dashboard:", expenseDetailsSnapshot.docs.length, "expenses found");

        expenseDetailsSnapshot.forEach((doc) => {
          const expenseData = doc.data();
          totalExpenses += expenseData.amount || 0;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${formatDateToDDMMYYYY(expenseData.createdAt)}</td>
            <td>${expenseData.description}</td>
            <td>${expenseData.amount}</td>
            <td>${expenseData.paymentMode || 'N/A'}</td>
          `;
          expenseTableBody.appendChild(row);
        });
        document.getElementById("totalExpenses").innerText = totalExpenses;
      } catch (error) {
        console.error("Error loading society dashboard:", error);
        document.getElementById("totalBankBalance").innerText = "Error";
        document.getElementById("cashInHand").innerText = "Error";
        document.getElementById("totalExpenses").innerText = "Error";
      }
    }

    // Toggle Expense Table
    window.toggleExpenseTable = function() {
      const expenseTable = document.getElementById("expenseTable");
      if (expenseTable.style.display === "none" || expenseTable.style.display === "") {
        expenseTable.style.display = "table";
      } else {
        expenseTable.style.display = "none";
      }
    };

    // Toggle Member List
    window.toggleMemberList = function() {
      const memberListContainer = document.getElementById("memberListContainer");
      const toggleButton = document.querySelector("#oldBalanceSection button");
      if (memberListContainer.style.display === "none" || memberListContainer.style.display === "") {
        memberListContainer.style.display = "block";
        toggleButton.textContent = "Hide Members";
      } else {
        memberListContainer.style.display = "none";
        toggleButton.textContent = "Show Members";
      }
    };

    // Load Members into Dropdowns (for Receipts and Old Balance)
    async function loadMembers() {
      console.log("Loading members for dropdowns...");
      const memberSelect = document.getElementById("receiptMemberId");
      const balanceMemberSelect = document.getElementById("balanceMemberId");
      const receiptMemberError = document.getElementById("receiptMemberError");
      const balanceMemberError = document.getElementById("balanceMemberError");
      memberSelect.innerHTML = '<option value="">Select Member</option>';
      if (balanceMemberSelect) {
        balanceMemberSelect.innerHTML = '<option value="">Select Member</option>';
      }

      try {
        const q = query(collection(db, "users"), where("role", "==", "member"), orderBy("name", "asc"));
        const querySnapshot = await getDocs(q);
        console.log("Members query result:", querySnapshot.docs.length, "members found");

        if (querySnapshot.empty) {
          receiptMemberError.innerText = "No members found.";
          if (balanceMemberError) balanceMemberError.innerText = "No members found.";
          console.log("No members found in Firestore.");
          return;
        }

        allMembers = [];
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          console.log("Member:", userData.name, "Phone:", userData.phone, "Old Balance:", userData.oldBalance);
          const option = document.createElement("option");
          option.value = doc.id;
          option.text = userData.name || "Unnamed Member";
          option.dataset.phone = userData.phone || '';
          memberSelect.appendChild(option);

          if (balanceMemberSelect) {
            const balanceOption = document.createElement("option");
            balanceOption.value = doc.id;
            balanceOption.text = (userData.name || "Unnamed Member") + " (Balance: " + (userData.oldBalance || 0) + ")";
            balanceMemberSelect.appendChild(balanceOption);
          }

          allMembers.push({
            id: doc.id,
            name: userData.name || "Unnamed Member",
            oldBalance: userData.oldBalance || 0
          });
        });
        receiptMemberError.innerText = "";
        if (balanceMemberError) balanceMemberError.innerText = "";
      } catch (error) {
        console.error("Error loading members: ", error);
        receiptMemberError.innerText = "Error loading members: " + error.message;
        if (balanceMemberError) balanceMemberError.innerText = "Error loading members: " + error.message;
      }
    }

    // Load Member Balances for Treasurer
    async function loadMemberBalances() {
      console.log("Loading member balances...");
      const memberList = document.getElementById("memberList");
      const memberListError = document.getElementById("memberListError");
      memberList.innerHTML = "";

      try {
        const q = query(collection(db, "users"), where("role", "==", "member"), orderBy("name", "asc"));
        const querySnapshot = await getDocs(q);
        console.log("Members query result for balances:", querySnapshot.docs.length, "members found");

        if (querySnapshot.empty) {
          memberList.innerHTML = "<p>No members found.</p>";
          memberListError.innerText = "No members found.";
          console.log("No members found for balances.");
          return;
        }

        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          const oldBalance = userData.oldBalance || 0; // Default to 0 if undefined
          console.log("Member balance:", userData.name, "Old Balance:", oldBalance);
          const memberDiv = document.createElement("div");
          memberDiv.className = "member";
          memberDiv.dataset.name = (userData.name || "Unnamed Member").toLowerCase();
          memberDiv.innerHTML = `
            <p>Name: ${userData.name || "Unnamed Member"}</p>
            <p>Old Balance: ${oldBalance}</p>
            <button class="edit-button" onclick="editBalance('${doc.id}', ${oldBalance})">Edit</button>
            <button class="delete-button" onclick="deleteBalance('${doc.id}')">Delete</button>
          `;
          memberList.appendChild(memberDiv);
        });
        memberListError.innerText = "";

        // Add search functionality
        document.getElementById("memberSearch").addEventListener("input", function() {
          const searchTerm = this.value.toLowerCase();
          const members = document.querySelectorAll("#memberList .member");
          members.forEach((member) => {
            const memberName = member.dataset.name;
            if (memberName.includes(searchTerm)) {
              member.style.display = "block";
            } else {
              member.style.display = "none";
            }
          });
        });
      } catch (error) {
        console.error("Error loading member balances:", error);
        memberListError.innerText = "Error loading member balances: " + error.message;
      }
    }

    // Update Old Balance (Treasurer only)
    function updateOldBalance() {
      const memberId = document.getElementById("balanceMemberId").value;
      const oldBalance = document.getElementById("oldBalanceAmount").value;
      const user = auth.currentUser;

      console.log("Updating old balance. Member ID:", memberId, "Balance:", oldBalance);

      if (!user) {
        alert("You need to be logged in to update balance!");
        return;
      }
      if (!memberId || !oldBalance) {
        alert("Please select a member and enter an amount!");
        return;
      }

      setDoc(doc(db, "users", memberId), { oldBalance: parseFloat(oldBalance) }, { merge: true })
        .then(() => {
          alert("Old balance updated successfully!");
          document.getElementById("balanceMemberId").value = "";
          document.getElementById("oldBalanceAmount").value = "";
          const balanceMemberSelect = document.getElementById("balanceMemberId");
          balanceMemberSelect.innerHTML = '<option value="">Select Member</option>';
          loadMembers();
          loadMemberBalances();
        })
        .catch((error) => {
          alert("Error updating old balance: " + error.message);
        });
    }

    // Edit Old Balance
    window.editBalance = function(memberId, oldBalance) {
      document.getElementById("editBalanceMemberId").value = memberId;
      document.getElementById("editBalanceAmount").value = oldBalance;
      document.getElementById("editBalanceSection").style.display = "block";
      document.getElementById("oldBalanceSection").style.display = "none";
    };

    // Save Edited Balance
    function saveEditedBalance() {
      const memberId = document.getElementById("editBalanceMemberId").value;
      const oldBalance = document.getElementById("editBalanceAmount").value;

      if (!oldBalance) {
        alert("Please enter an amount!");
        return;
      }

      setDoc(doc(db, "users", memberId), { oldBalance: parseFloat(oldBalance) }, { merge: true })
        .then(() => {
          alert("Old balance updated successfully!");
          document.getElementById("editBalanceSection").style.display = "none";
          document.getElementById("oldBalanceSection").style.display = "block";
          loadMemberBalances();
          const balanceMemberSelect = document.getElementById("balanceMemberId");
          balanceMemberSelect.innerHTML = '<option value="">Select Member</option>';
          loadMembers();
        })
        .catch((error) => {
          alert("Error updating old balance: " + error.message);
        });
    }

    // Cancel Edit Balance
    function cancelEditBalance() {
      document.getElementById("editBalanceSection").style.display = "none";
      document.getElementById("oldBalanceSection").style.display = "block";
    }

    // Delete Old Balance (Set to 0)
    window.deleteBalance = function(memberId) {
      if (confirm("Are you sure you want to delete this balance? It will be set to 0.")) {
        setDoc(doc(db, "users", memberId), { oldBalance: 0 }, { merge: true })
          .then(() => {
            alert("Old balance deleted (set to 0) successfully!");
            loadMemberBalances();
            const balanceMemberSelect = document.getElementById("balanceMemberId");
            balanceMemberSelect.innerHTML = '<option value="">Select Member</option>';
            loadMembers();
          })
          .catch((error) => {
            alert("Error deleting old balance: " + error.message);
          });
      }
    };

    // Load Banks into Dropdowns (for Receipts and Expenses)
    async function loadBanksForDropdowns() {
      const receiptBankSelect = document.getElementById("receiptBankId");
      const expenseBankSelect = document.getElementById("expenseBankId");
      const editReceiptBankSelect = document.getElementById("editReceiptBankId");
      const editExpenseBankSelect = document.getElementById("editExpenseBankId");

      receiptBankSelect.innerHTML = '<option value="">Select Bank</option>';
      expenseBankSelect.innerHTML = '<option value="">Select Bank</option>';
      editReceiptBankSelect.innerHTML = '<option value="">Select Bank</option>';
      editExpenseBankSelect.innerHTML = '<option value="">Select Bank</option>';

      try {
        const querySnapshot = await getDocs(collection(db, "bank"));
        querySnapshot.forEach((doc) => {
          const bankData = doc.data();
          const option1 = document.createElement("option");
          const option2 = document.createElement("option");
          const option3 = document.createElement("option");
          const option4 = document.createElement("option");
          option1.value = doc.id;
          option1.text = `${bankData.bankName} (Balance: ${bankData.amount || 0})`;
          option2.value = doc.id;
          option2.text = `${bankData.bankName} (Balance: ${bankData.amount || 0})`;
          option3.value = doc.id;
          option3.text = `${bankData.bankName} (Balance: ${bankData.amount || 0})`;
          option4.value = doc.id;
          option4.text = `${bankData.bankName} (Balance: ${bankData.amount || 0})`;
          receiptBankSelect.appendChild(option1);
          expenseBankSelect.appendChild(option2);
          editReceiptBankSelect.appendChild(option3);
          editExpenseBankSelect.appendChild(option4);
        });
      } catch (error) {
        console.error("Error loading banks for dropdowns:", error);
      }
    }

    // Add Bank Entry (Treasurer only)
    function addBankEntry() {
      const bankName = document.getElementById("bankName").value;
      const amount = document.getElementById("bankAmount").value;
      const user = auth.currentUser;

      console.log("Adding bank entry. Bank Name:", bankName, "Amount:", amount);

      if (!user) {
        alert("You need to be logged in to add a bank entry!");
        return;
      }
      if (!bankName || !amount) {
        alert("Please fill in all fields!");
        return;
      }

      addDoc(collection(db, "bank"), {
        bankName: bankName,
        amount: parseFloat(amount),
        createdBy: user.uid,
        createdAt: serverTimestamp()
      })
      .then(() => {
        alert("Bank entry added successfully!");
        document.getElementById("bankName").value = "";
        document.getElementById("bankAmount").value = "";
        loadBankDetails();
        loadBanksForDropdowns();
      })
      .catch((error) => {
        alert("Error adding bank entry: " + error.message);
      });
    }

    // Sort Bank Table
    window.sortBankTable = async function(columnIndex) {
      bankSortDirection *= -1; // Toggle between ascending and descending
      const direction = bankSortDirection === -1 ? "desc" : "asc";
      loadBankDetails(direction);
    };

    // Load Bank Details (Treasurer only)
    async function loadBankDetails(sortOrder = "desc") {
      console.log("Loading bank details...");
      const bankTableBody = document.getElementById("bankTableBody");
      const bankListError = document.getElementById("bankListError");
      bankTableBody.innerHTML = "";

      try {
        const q = query(collection(db, "bank"), orderBy("createdAt", sortOrder));
        const querySnapshot = await getDocs(q);
        console.log("Bank details snapshot:", querySnapshot.docs.length, "entries found");

        if (querySnapshot.empty) {
          bankTableBody.innerHTML = "<tr><td colspan='3'>No bank entries found.</td></tr>";
          bankListError.innerText = "No bank entries found.";
          return;
        }

        querySnapshot.forEach((doc) => {
          const bankData = doc.data();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${formatDateToDDMMYYYY(bankData.createdAt)}</td>
            <td>${bankData.bankName}</td>
            <td>${bankData.amount}</td>
          `;
          bankTableBody.appendChild(row);
        });
        bankListError.innerText = "";
        loadBanksForDropdowns();
      } catch (error) {
        console.error("Error loading bank details:", error);
        bankListError.innerText = "Error loading bank details: " + error.message;
      }
    }

    // Edit Bank Entry
    window.editBank = function(bankId, bankName, amount) {
      document.getElementById("editBankId").value = bankId;
      document.getElementById("editBankName").value = bankName;
      document.getElementById("editBankAmount").value = amount;
      document.getElementById("editBankSection").style.display = "block";
      document.getElementById("bankSection").style.display = "none";
    };

    // Save Edited Bank Entry
    function saveEditedBank() {
      const bankId = document.getElementById("editBankId").value;
      const bankName = document.getElementById("editBankName").value;
      const amount = document.getElementById("editBankAmount").value;

      if (!bankName || !amount) {
        alert("Please fill in all fields!");
        return;
      }

      updateDoc(doc(db, "bank", bankId), {
        bankName: bankName,
        amount: parseFloat(amount)
      })
      .then(() => {
        alert("Bank entry updated successfully!");
        document.getElementById("editBankSection").style.display = "none";
        document.getElementById("bankSection").style.display = "block";
        loadBankDetails();
      })
      .catch((error) => {
        alert("Error updating bank entry: " + error.message);
      });
    }

    // Cancel Edit Bank Entry
    function cancelEditBank() {
      document.getElementById("editBankSection").style.display = "none";
      document.getElementById("bankSection").style.display = "block";
    }

    // Delete Bank Entry
    window.deleteBank = function(bankId) {
      if (confirm("Are you sure you want to delete this bank entry?")) {
        deleteDoc(doc(db, "bank", bankId))
          .then(() => {
            alert("Bank entry deleted successfully!");
            loadBankDetails();
          })
          .catch((error) => {
            alert("Error deleting bank entry: " + error.message);
          });
      }
    };

    // Add Expense (Treasurer only)
    async function addExpense() {
      const description = document.getElementById("expenseDescription").value;
      const amount = parseFloat(document.getElementById("expenseAmount").value);
      const paymentMode = document.getElementById("expensePaymentMode").value;
      const bankId = document.getElementById("expenseBankId").value;
      const user = auth.currentUser;

      console.log("Adding expense. Description:", description, "Amount:", amount, "Payment Mode:", paymentMode);

      if (!user) {
        alert("You need to be logged in to add an expense!");
        return;
      }
      if (!description || !amount) {
        alert("Please fill in all fields!");
        return;
      }
      if (paymentMode === "Bank" && !bankId) {
        alert("Please select a bank for the payment!");
        return;
      }

      // Update bank balance if payment mode is Bank
      if (paymentMode === "Bank") {
        const bankRef = doc(db, "bank", bankId);
        const bankSnap = await getDoc(bankRef);
        if (bankSnap.exists()) {
          const bankData = bankSnap.data();
          const newBankBalance = (bankData.amount || 0) - amount;
          if (newBankBalance < 0) {
            alert("Insufficient funds in the selected bank account!");
            return;
          }
          await updateDoc(bankRef, { amount: newBankBalance });
        }
      }

      // Add expense to Firestore
      await addDoc(collection(db, "expenses"), {
        description: description,
        amount: amount,
        paymentMode: paymentMode,
        bankId: paymentMode === "Bank" ? bankId : null,
        createdBy: user.uid,
        createdAt: serverTimestamp()
      });

      alert("Expense added successfully!");
      document.getElementById("expenseDescription").value = "";
      document.getElementById("expenseAmount").value = "";
      document.getElementById("expensePaymentMode").value = "Cash";
      document.getElementById("expenseBankId").value = "";
      document.getElementById("expenseBankId").style.display = "none";
      loadExpenses();
      loadSocietyDashboard();
      sendExpenseMessageToMembers(description, amount, paymentMode);
    }

    // Send Expense Message to All Members
    function sendExpenseMessageToMembers(description, amount, paymentMode) {
      const q = query(collection(db, "users"), where("role", "==", "member"), orderBy("name", "asc"));
      getDocs(q)
        .then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const phone = userData.phone;
            console.log("Sending expense message to member:", userData.name, "Phone:", phone);
            if (phone) {
              const message = `New expense added: ${description}, Amount: ${amount}, Payment Mode: ${paymentMode}.`;
              const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
              console.log("Expense WhatsApp URL:", whatsappUrl);
              window.open(whatsappUrl, '_blank');
            } else {
              console.log("No phone number found for member:", userData.name);
            }
          });
        })
        .catch((error) => {
          console.error("Error fetching members for expense message: ", error);
        });
    }

    // Sort Expense Table
    window.sortExpenseTable = async function(columnIndex) {
      expenseSortDirection *= -1; // Toggle between ascending and descending
      const direction = expenseSortDirection === -1 ? "desc" : "asc";
      loadExpenses(direction);
      loadSocietyDashboard(); // Update the dashboard expense table as well
    };

    // Load Expenses (Treasurer only)
    async function loadExpenses(sortOrder = "desc") {
      console.log("Loading expenses...");
      const expenseTableBody = document.getElementById("expenseTableBodyFull");
      const expenseListError = document.getElementById("expenseListError");
      expenseTableBody.innerHTML = "";

      try {
        const q = query(collection(db, "expenses"), orderBy("createdAt", sortOrder));
        const querySnapshot = await getDocs(q);
        console.log("Expenses snapshot:", querySnapshot.docs.length, "entries found");

        if (querySnapshot.empty) {
          expenseTableBody.innerHTML = "<tr><td colspan='4'>No expenses found.</td></tr>";
          expenseListError.innerText = "No expenses found.";
          return;
        }

        querySnapshot.forEach((doc) => {
          const expenseData = doc.data();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${formatDateToDDMMYYYY(expenseData.createdAt)}</td>
            <td>${expenseData.description}</td>
            <td>${expenseData.amount}</td>
            <td>${expenseData.paymentMode || 'N/A'}</td>
          `;
          expenseTableBody.appendChild(row);
        });
        expenseListError.innerText = "";
      } catch (error) {
        console.error("Error loading expenses:", error);
        expenseListError.innerText = "Error loading expenses: " + error.message;
      }
    }

    // Edit Expense
    window.editExpense = function(expenseId, description, amount, paymentMode, bankId) {
      document.getElementById("editExpenseId").value = expenseId;
      document.getElementById("editExpenseDescription").value = description;
      document.getElementById("editExpenseAmount").value = amount;
      document.getElementById("editExpensePaymentMode").value = paymentMode;
      document.getElementByMemberId("editExpenseBankId").value = bankId;
      if (paymentMode === "Bank") {
        document.getElementById("editExpenseBankId").style.display = "block";
      } else {
        document.getElementById("editExpenseBankId").style.display = "none";
      }
      document.getElementById("editExpenseSection").style.display = "block";
      document.getElementById("expensesSection").style.display = "none";
    };

    // Save Edited Expense
    async function saveEditedExpense() {
      const expenseId = document.getElementById("editExpenseId").value;
      const description = document.getElementById("editExpenseDescription").value;
      const amount = parseFloat(document.getElementById("editExpenseAmount").value);
      const paymentMode = document.getElementById("editExpensePaymentMode").value;
      const bankId = document.getElementById("editExpenseBankId").value;

      if (!description || !amount) {
        alert("Please fill in all fields!");
        return;
      }
      if (paymentMode === "Bank" && !bankId) {
        alert("Please select a bank for the payment!");
        return;
      }

      // Update bank balance if payment mode is Bank
      if (paymentMode === "Bank") {
        const bankRef = doc(db, "bank", bankId);
        const bankSnap = await getDoc(bankRef);
        if (bankSnap.exists()) {
          const bankData = bankSnap.data();
          const newBankBalance = (bankData.amount || 0) - amount;
          if (newBankBalance < 0) {
            alert("Insufficient funds in the selected bank account!");
            return;
          }
          await updateDoc(bankRef, { amount: newBankBalance });
        }
      }

      await updateDoc(doc(db, "expenses", expenseId), {
        description: description,
        amount: amount,
        paymentMode: paymentMode,
        bankId: paymentMode === "Bank" ? bankId : null
      });

      alert("Expense updated successfully!");
      document.getElementById("editExpenseSection").style.display = "none";
      document.getElementById("expensesSection").style.display = "block";
      loadExpenses();
      loadSocietyDashboard();
    }

    // Cancel Edit Expense
    function cancelEditExpense() {
      document.getElementById("editExpenseSection").style.display = "none";
      document.getElementById("expensesSection").style.display = "block";
    }

    // Delete Expense
    window.deleteExpense = function(expenseId) {
      if (confirm("Are you sure you want to delete this expense?")) {
        deleteDoc(doc(db, "expenses", expenseId))
          .then(() => {
            alert("Expense deleted successfully!");
            loadExpenses();
            loadSocietyDashboard();
          })
          .catch((error) => {
            alert("Error deleting expense: " + error.message);
          });
      }
    };

    // Create Receipt (Treasurer and Caretaker)
    async function createReceipt() {
      const memberId = document.getElementById("receiptMemberId").value;
      const amount = parseFloat(document.getElementById("receiptAmount").value);
      const status = document.getElementById("receiptStatus").value;
      const paymentMode = document.getElementById("paymentMode").value;
      const bankId = document.getElementById("receiptBankId").value;
      const receiptNumberInput = document.getElementById("receiptNumber").value;
      const user = auth.currentUser;

      console.log("Creating receipt. Member ID:", memberId, "Amount:", amount, "Status:", status);

      if (!user) {
        alert("You need to be logged in to create a receipt!");
        return;
      }
      if (!memberId || !amount) {
        alert("Please fill in all fields!");
        return;
      }
      if (status === "final" && !receiptNumberInput) {
        alert("Please enter a receipt number for Final receipt!");
        return;
      }
      if (paymentMode === "Bank" && !bankId) {
        alert("Please select a bank for the payment!");
        return;
      }

      let receiptNumber = receiptNumberInput;
      if (status === "temporary") {
        const counterRef = doc(db, "counters", "receiptCounter");
        const counterSnap = await getDoc(counterRef);
        let currentCount = 0;
        if (counterSnap.exists()) {
          currentCount = counterSnap.data().temporaryReceiptCount || 0;
        }
        currentCount++;
        receiptNumber = `TEMP-${currentCount}`;
        await setDoc(counterRef, { temporaryReceiptCount: currentCount }, { merge: true });
      }

      const memberSelect = document.getElementById("receiptMemberId");
      const selectedOption = memberSelect.options[memberSelect.selectedIndex];
      const memberName = selectedOption.text;
      const memberPhone = selectedOption.dataset.phone;

      // Update member balance only if the receipt is final
      if (status === "final") {
        const memberRef = doc(db, "users", memberId);
        const memberSnap = await getDoc(memberRef);
        if (memberSnap.exists()) {
          const memberData = memberSnap.data();
          const currentBalance = memberData.oldBalance || 0;
          const newBalance = currentBalance - amount;
          await updateDoc(memberRef, { oldBalance: newBalance });
        }

        // Update bank balance if payment mode is Bank
        if (paymentMode === "Bank") {
          const bankRef = doc(db, "bank", bankId);
          const bankSnap = await getDoc(bankRef);
          if (bankSnap.exists()) {
            const bankData = bankSnap.data();
            const newBankBalance = (bankData.amount || 0) + amount;
            await updateDoc(bankRef, { amount: newBankBalance });
          }
        }
      }

      await addDoc(collection(db, "receipts"), {
        memberId: memberId,
        memberName: memberName,
        amount: amount,
        createdBy: user.uid,
        createdByName: currentUserName,
        createdAt: serverTimestamp(),
        status: status,
        receiptNumber: receiptNumber,
        paymentMode: paymentMode,
        bankId: paymentMode === "Bank" ? bankId : null
      });

      alert("Receipt created successfully!");
      document.getElementById("receiptMemberId").value = "";
      document.getElementById("receiptAmount").value = "";
      document.getElementById("receiptStatus").value = "temporary";
      document.getElementById("receiptNumber").value = "";
      document.getElementById("paymentMode").value = "Cash";
      document.getElementById("receiptBankId").value = "";
      document.getElementById("receiptBankId").style.display = "none";
      loadCreatedReceipts(user.uid);
      loadMemberBalances();
      loadSocietyDashboard();
      if (currentUserRole === "member") {
        loadMemberDashboard(user.uid);
      }

      if (currentUserRole === "caretaker") {
        const treasurerQuery = query(collection(db, "users"), where("role", "==", "treasurer"));
        getDocs(treasurerQuery).then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            const treasurerData = doc.data();
            const treasurerPhone = treasurerData.phone;
            console.log("Treasurer phone:", treasurerPhone);
            if (treasurerPhone) {
              const message = `Caretaker ${currentUserName} has generated a temporary receipt for ${memberName}, Amount: ${amount}, Receipt No: ${receiptNumber}.`;
              const whatsappUrl = `https://wa.me/${treasurerPhone}?text=${encodeURIComponent(message)}`;
              console.log("Treasurer WhatsApp URL:", whatsappUrl);
              window.open(whatsappUrl, '_blank');
            } else {
              console.log("No phone number found for treasurer");
            }
          });
        });

        console.log("Member phone:", memberPhone);
        if (memberPhone) {
          const message = `You have a new temporary receipt from Caretaker ${currentUserName}. Amount: ${amount}, Receipt No: ${receiptNumber}.`;
          const whatsappUrl = `https://wa.me/${memberPhone}?text=${encodeURIComponent(message)}`;
          console.log("Member WhatsApp URL:", whatsappUrl);
          window.open(whatsappUrl, '_blank');
        } else {
          console.log("No phone number found for member:", memberName);
        }
      } else if (currentUserRole === "treasurer") {
        console.log("Member phone:", memberPhone);
        if (memberPhone) {
          const message = `You have a new ${status} receipt from Treasurer. Amount: ${amount}, Receipt No: ${receiptNumber}.`;
          const whatsappUrl = `https://wa.me/${memberPhone}?text=${encodeURIComponent(message)}`;
          console.log("Member WhatsApp URL:", whatsappUrl);
          window.open(whatsappUrl, '_blank');
        } else {
          console.log("No phone number found for member:", memberName);
        }
      }
    }

    // Sort Created Receipts Table
    window.sortReceiptTable = async function(columnIndex) {
      receiptSortDirection *= -1; // Toggle between ascending and descending
      const direction = receiptSortDirection === -1 ? "desc" : "asc";
      const user = auth.currentUser;
      if (user) {
        loadCreatedReceipts(user.uid, direction);
      }
    };

    // Load Created Receipts for Treasurer and Caretaker
    async function loadCreatedReceipts(uid, sortOrder = "desc") {
      console.log("Loading created receipts for UID:", uid);
      const createdReceiptTableBody = document.getElementById("createdReceiptTableBody");
      const createdReceiptListError = document.getElementById("createdReceiptListError");
      createdReceiptTableBody.innerHTML = "";

      try {
        const q = query(
          collection(db, "receipts"),
          where("createdBy", "==", uid),
          orderBy("createdAt", sortOrder)
        );
        const querySnapshot = await getDocs(q);
        console.log("Created receipts snapshot:", querySnapshot.docs.length, "receipts found");

        if (querySnapshot.empty) {
          createdReceiptTableBody.innerHTML = "<tr><td colspan='5'>No receipts created.</td></tr>";
          createdReceiptListError.innerText = "No receipts created.";
          return;
        }

        querySnapshot.forEach((doc) => {
          const receipt = doc.data();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${formatDateToDDMMYYYY(receipt.createdAt)}</td>
            <td>${receipt.receiptNumber}</td>
            <td>${receipt.memberName}</td>
            <td>${receipt.paymentMode}</td>
            <td>${receipt.amount}</td>
          `;
          createdReceiptTableBody.appendChild(row);
        });
        createdReceiptListError.innerText = "";
      } catch (error) {
        console.error("Error loading created receipts:", error);
        createdReceiptListError.innerText = "Error loading created receipts: " + error.message;
      }
    }

    // Load Receipts for Members
    async function loadMemberReceipts(uid) {
      console.log("Loading receipts for member UID:", uid);
      const memberReceiptTableBody = document.getElementById("memberReceiptTableBody");
      const receiptListError = document.getElementById("receiptListError");
      memberReceiptTableBody.innerHTML = "";

      try {
        const q = query(collection(db, "receipts"), where("memberId", "==", uid), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        console.log("Member receipts snapshot:", querySnapshot.docs.length, "receipts found");

        if (querySnapshot.empty) {
          memberReceiptTableBody.innerHTML = "<tr><td colspan='5'>No receipts found.</td></tr>";
          receiptListError.innerText = "No receipts found.";
          return;
        }

        querySnapshot.forEach((doc) => {
          const receipt = doc.data();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${receipt.receiptNumber}</td>
            <td>${formatDateToDDMMYYYY(receipt.createdAt)}</td>
            <td>${receipt.memberName}</td>
            <td>${receipt.paymentMode}</td>
            <td>${receipt.amount}</td>
          `;
          memberReceiptTableBody.appendChild(row);
        });
        receiptListError.innerText = "";
      } catch (error) {
        console.error("Error loading member receipts:", error);
        receiptListError.innerText = "Error loading receipts: " + error.message;
      }
    }

    // Logout Function
    function logout() {
      console.log("Logging out...");
      signOut(auth)
        .then(() => {
          document.getElementById("loginSection").style.display = "block";
          document.getElementById("userInfo").style.display = "none";
          document.getElementById("oldBalanceSection").style.display = "none";
          document.getElementById("bankSection").style.display = "none";
          document.getElementById("expensesSection").style.display = "none";
          document.getElementById("receiptSection").style.display = "none";
          document.getElementById("createdReceipts").style.display = "none";
          document.getElementById("memberReceipts").style.display = "none";
          document.getElementById("editReceiptSection").style.display = "none";
          document.getElementById("editBalanceSection").style.display = "none";
          document.getElementById("editBankSection").style.display = "none";
          document.getElementById("editExpenseSection").style.display = "none";
          document.getElementById("societyDashboard").style.display = "none";
          document.getElementById("memberDashboard").style.display = "none";
        })
        .catch((error) => {
          alert("Logout failed: " + error.message);
        });
    }

    // Show/Hide Receipt Number Input based on Status
    document.getElementById("receiptStatus").addEventListener("change", function() {
      const status = this.value;
      const receiptNumberInput = document.getElementById("receiptNumber");
      if (status === "final") {
        receiptNumberInput.style.display = "block";
      } else {
        receiptNumberInput.style.display = "none";
        receiptNumberInput.value = "";
      }
    });

    // Show/Hide Bank Dropdown based on Payment Mode
    document.getElementById("paymentMode").addEventListener("change", function() {
      const paymentMode = this.value;
      const bankSelect = document.getElementById("receiptBankId");
      if (paymentMode === "Bank") {
        bankSelect.style.display = "block";
      } else {
        bankSelect.style.display = "none";
        bankSelect.value = "";
      }
    });

    document.getElementById("expensePaymentMode").addEventListener("change", function() {
      const paymentMode = this.value;
      const bankSelect = document.getElementById("expenseBankId");
      if (paymentMode === "Bank") {
        bankSelect.style.display = "block";
      } else {
        bankSelect.style.display = "none";
        bankSelect.value = "";
      }
    });

    document.getElementById("editExpensePaymentMode").addEventListener("change", function() {
      const paymentMode = this.value;
      const bankSelect = document.getElementById("editExpenseBankId");
      if (paymentMode === "Bank") {
        bankSelect.style.display = "block";
      } else {
        bankSelect.style.display = "none";
        bankSelect.value = "";
      }
    });

    // Add event listeners to buttons
    document.getElementById("loginButton").addEventListener("click", login);
    document.getElementById("logoutButton").addEventListener("click", logout);
    document.getElementById("updateBalanceButton").addEventListener("click", updateOldBalance);
    document.getElementById("addBankButton").addEventListener("click", addBankEntry);
    document.getElementById("addExpenseButton").addEventListener("click", addExpense);
    document.getElementById("createReceiptButton").addEventListener("click", createReceipt);
    document.getElementById("saveEditBalanceButton").addEventListener("click", saveEditedBalance);
    document.getElementById("cancelEditBalanceButton").addEventListener("click", cancelEditBalance);
    document.getElementById("saveEditBankButton").addEventListener("click", saveEditedBank);
    document.getElementById("cancelEditBankButton").addEventListener("click", cancelEditBank);
    document.getElementById("saveEditExpenseButton").addEventListener("click", saveEditedExpense);
    document.getElementById("cancelEditExpenseButton").addEventListener("click", cancelEditExpense);
  </script>
</body>
</html>